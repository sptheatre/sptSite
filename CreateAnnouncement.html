<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Announcement</title>
    <link rel="stylesheet" href="theater.css">
    <link rel="stylesheet" href="Login.css">
</head>
<body>
    <nav class="navbar">
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="https://cur8.com/projects/40174?action=donation" target="_blank" rel="noopener noreferrer">Donate</a></li>
            <li><a href="Newsletter.html">Newsletter</a></li>
            <li><a href="Announcements.html">Announcements</a></li>
        </ul>
    </nav>
    <div class="login-container">
            <a class="feedback" href="https://docs.google.com/spreadsheets/d/1_7aARd3k301D1e1s4VSX7W_p6k19r8TtN6CHIAaMrbA/edit?usp=sharing" target="_blank" rel="noopener noreferrer">Announcement Google Sheet</a>
        <form id="announcementForm" autocomplete="off">
            <h2>Create Announcement</h2>
            <input type="text" id="announcementName" name="name" placeholder="Your name" required style="width: 100%; margin-bottom: 1rem; font-size: 1.1em;">
            <input type="text" id="announcementTitle" name="title" placeholder="Title" required style="width: 100%; margin-bottom: 1rem; font-size: 1.1em;">
            <textarea id="announcementBody" name="body" placeholder="Announcement body..." required style="width: 100%; height: 120px; margin-bottom: 1rem; resize: none; font-size: 1.1em;"></textarea>
            <style>
            #announcementName::placeholder,
            #announcementTitle::placeholder,
            #announcementBody::placeholder {
                font-size: 1.1em;
            }
            </style>
            <input type="hidden" id="editIndex">
            <button type="submit">Post Announcement</button>
            <div id="announcementMessage"></div>
        </form>
        <div id="announcementList" style="width:100%;margin-top:2rem;"></div>
    </div>
    <script>

        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxXvGzOagGinncDEzj5X1uV-iupdcZ22bEzUOFkFDhR-IXTbYut9eBZ6PYS5oCeV70b/exec';

        function formatTime(iso) {
            const d = new Date(iso);
            return d.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' });
        }

        function renderAnnouncements() {
            const list = document.getElementById('announcementList');
            list.innerHTML = '<div style="text-align:center;color:#888;">Loading...</div>';
            fetch(WEB_APP_URL)
                .then(response => response.json())
                .then(announcements => {
                    list.innerHTML = '';
                    if (!announcements || !announcements.length) {
                        list.innerHTML = '<div style="text-align:center;color:#888;">No announcements yet.</div>';
                        return;
                    }
                    list.innerHTML = announcements.map((a, i) => {
                        const rowNum = i + 2; // Row 1 is header, so first announcement is row 2
                        // If edited, show edited time box
                        let editedBox = '';
                        if (a.edited && a.edited !== '') {
                            editedBox = `<div style="position:absolute;bottom:8px;right:12px;font-size:0.8em;color:#666;background:#eee;padding:2px 8px;border-radius:6px;">edited: ${formatTime(a.edited)}</div>`;
                        }
                        return `
                            <div class="announcement" style="position:relative;margin-bottom:1.5rem;padding:1rem 1.5rem;background:#fafafa;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.04);">
                                <div style="position:absolute;top:8px;right:12px;font-size:0.8em;color:#666;background:#eee;padding:2px 8px;border-radius:6px;">${formatTime(a.date)}</div>
                                <div class="announcement-title" style="font-weight:600;font-size:1.1em;">${a.title}</div>
                                <div class="announcement-name" style="font-size:0.95em;color:#444;margin-bottom:0.3em;">${a.name ? 'By: ' + a.name : ''}</div>
                                <div class="announcement-body" style="margin:0.5em 0 0.7em 0;">${a.body}</div>
                                <button onclick="editAnnouncement(${rowNum}, '${a.name.replace(/'/g, "&#39;")}', '${a.title.replace(/'/g, "&#39;")}', '${a.body.replace(/'/g, "&#39;")}', '${a.date}', '${a.edited ? a.edited : ''}')" style="margin-right:0.5em;">Edit</button>
                                <button onclick="deleteAnnouncement(${rowNum})" style="background:#c00;color:#fff;">Delete</button>
                                ${editedBox}
                            </div>
                        `;
                    }).join('');
                })
                .catch(() => {
                    list.innerHTML = '<div style="text-align:center;color:#c00;">Failed to load announcements.</div>';
                });
        }

        let editingRowNum = null;
        let originalDate = null;
        document.getElementById('announcementForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('announcementName').value.trim();
            const title = document.getElementById('announcementTitle').value.trim();
            const body = document.getElementById('announcementBody').value.trim();
            if (!name || !title || !body) {
                document.getElementById('announcementMessage').textContent = 'All fields are required.';
                document.getElementById('announcementMessage').style.color = 'red';
                return;
            }
            const formData = new FormData();
            formData.append('name', name);
            formData.append('title', title);
            formData.append('body', body);
            if (editingRowNum) {
                formData.append('action', 'edit');
                formData.append('rowNum', editingRowNum);
                formData.append('date', originalDate); // preserve original date
                formData.append('edited', new Date().toISOString()); // new edited time
            } else {
                formData.append('date', new Date().toISOString());
            }
            fetch(WEB_APP_URL, {
                method: 'POST',
                body: formData
            })
            .then(res => {
                if (res.ok) {
                    document.getElementById('announcementMessage').textContent = editingRowNum ? 'Announcement updated!' : 'Announcement posted!';
                    document.getElementById('announcementMessage').style.color = 'green';
                    document.getElementById('announcementForm').reset();
                    editingRowNum = null;
                    originalDate = null;
                    renderAnnouncements();
                } else {
                    document.getElementById('announcementMessage').textContent = 'Failed to post announcement.';
                    document.getElementById('announcementMessage').style.color = 'red';
                }
            })
            .catch(() => {
                document.getElementById('announcementMessage').textContent = 'Failed to post announcement.';
                document.getElementById('announcementMessage').style.color = 'red';
            });
        });

        window.editAnnouncement = function(rowNum, name, title, body, date, edited) {
            document.getElementById('announcementName').value = name;
            document.getElementById('announcementTitle').value = title;
            document.getElementById('announcementBody').value = body;
            editingRowNum = rowNum;
            originalDate = date;
            document.getElementById('announcementMessage').textContent = 'Editing announcement...';
            document.getElementById('announcementMessage').style.color = '#333';
        };

        window.deleteAnnouncement = function(rowNum) {
            if (!confirm('Delete this announcement?')) return;
            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('rowNum', rowNum);
            fetch(WEB_APP_URL, {
                method: 'POST',
                body: formData
            })
            .then(res => res.ok ? res.json() : Promise.reject(res))
            .then(data => {
                document.getElementById('announcementMessage').textContent = 'Announcement deleted.';
                document.getElementById('announcementMessage').style.color = 'red';
                document.getElementById('announcementForm').reset();
                editingRowNum = null;
                renderAnnouncements();
            })
            .catch(() => {
                document.getElementById('announcementMessage').textContent = 'Failed to delete announcement.';
                document.getElementById('announcementMessage').style.color = 'red';
            });
        };

        renderAnnouncements();
    </script>
</body>
</html>
